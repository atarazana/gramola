apiVersion: tekton.dev/v1beta1
kind: ClusterTask
metadata:
  annotations:
    tekton.dev/displayName: GitHub create pull request cluster task
    tekton.dev/pipelines.minVersion: '0.19'
    tekton.dev/tags: 'argocd, gitops'
  name: argocd-sync
  labels:
    app.kubernetes.io/version: '0.1'
    operator.tekton.dev/provider-type: redhat
spec:
  description: >-
    These Task triggers a sync operation.
  params:
    - description: Name of the Application to sync
      name: APP_NAME
      type: string
    - description: Overlay suffix if twin overlay
      name: TWIN_OVERLAY_SUFFIX
      type: string
      default: "cloud"
    - default: quay.io/atarazana/argocd:0.0.1
      description: The image used where the argocd binary is
      name: TASK_IMAGE
      type: string
  results:
    - description: Success or failure
      name: APP_SYNC_SUCCESS
  steps:
    - image: $(params.TASK_IMAGE)
      name: eval
      resources: {}
      script: |
        #!/bin/sh

        echo "ARGOCD_VERSION=$(argocd version)"
        echo "OC_VERSION=$(oc version)"

        ARGOCD_USERNAME=admin
        ARGOCD_SERVER=$(oc get route/openshift-gitops-server -o jsonpath='{.status.ingress[0].host}' -n openshift-gitops)
        ARGOCD_PASSWORD=$(oc get secret openshift-gitops-cluster -o jsonpath='{.data.admin\.password}' -n openshift-gitops | base64 -d)

        argocd login $ARGOCD_SERVER --insecure --username $ARGOCD_USERNAME --password $ARGOCD_PASSWORD

        argocd app sync --timeout 120 $(params.APP_NAME)
        if [ "$?" == 0 ]; then
          argocd app get $(params.APP_NAME)-$(params.TWIN_OVERLAY_SUFFIX)
          if [ "$?" == 0 ]; then
            argocd app sync --timeout 120 $(params.APP_NAME)-$(params.TWIN_OVERLAY_SUFFIX)
            if [ "$?" ne 0 ]; then
              echo "ERROR WHILE SYNCING TWIN APP $(params.APP_NAME)-$(params.TWIN_OVERLAY_SUFFIX)"
              echo -n "false" > $(results.APP_SYNC_SUCCESS.path)
              exit 1
            fi
          else
            echo "No Twin App called: $(params.APP_NAME)-$(params.TWIN_OVERLAY_SUFFIX)"
          fi
        else
          echo "ERROR WHILE SYNCING $(params.APP_NAME)"
          echo -n "false" > $(results.APP_SYNC_SUCCESS.path)
          exit 1
        fi
        
        echo -n "true" > $(results.APP_SYNC_SUCCESS.path)
